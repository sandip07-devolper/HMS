
/* =========================
   TENANTS
========================= */
CREATE TABLE Tenants (
    TenantID INT IDENTITY(1,1) PRIMARY KEY,
    TenantName NVARCHAR(150) NOT NULL,
    Domain NVARCHAR(100) NULL,
    IsActive BIT DEFAULT 1,
    CreatedDate NVARCHAR(20)
);


/* =========================
   ROLES
========================= */
CREATE TABLE Roles (
    RoleID INT PRIMARY KEY,
    RoleName NVARCHAR(50) NOT NULL,
    IsActive BIT NOT NULL DEFAULT 1  -- 1 = active, 0 = inactive
);



/* =========================
   USER MAIN (AUTH TABLE)
========================= */
CREATE TABLE UserMain (
    UserID INT IDENTITY(1,1) PRIMARY KEY,

    TenantID INT NULL,  -- NULL = Platform / SuperAdmin
    -- NOT NULL = Tenant User

    Username NVARCHAR(100) NOT NULL,
    Email NVARCHAR(150) NOT NULL,

    PasswordHash NVARCHAR(500) NOT NULL,

    RoleID INT NOT NULL,

    IsActive BIT NOT NULL DEFAULT 1,
    IsEmailConfirmed BIT NOT NULL DEFAULT 0,

    EmailConfirmationToken NVARCHAR(200) NULL,
    EmailConfirmationExpiry NVARCHAR(20) NULL,

    PasswordResetToken NVARCHAR(200) NULL,
    PasswordResetExpiry NVARCHAR(20) NULL,

    CreatedDate NVARCHAR(20),

    CONSTRAINT UQ_User_Tenant_Username UNIQUE (TenantID, Username),
    CONSTRAINT UQ_User_Email UNIQUE (Email),

    CONSTRAINT FK_User_Tenant FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    CONSTRAINT FK_User_Role FOREIGN KEY (RoleID) REFERENCES Roles(RoleID)
);


/* =========================
   LOCATION TABLES
========================= */
CREATE TABLE Province (
    ProvinceID INT IDENTITY(1,1) PRIMARY KEY,
    ProvinceName NVARCHAR(100) NOT NULL
);

CREATE TABLE District (
    DistrictID INT IDENTITY(1,1) PRIMARY KEY,
    DistrictName NVARCHAR(100) NOT NULL,
    ProvinceID INT,
    DistrictName_Nep NVARCHAR(100),
    FOREIGN KEY (ProvinceID) REFERENCES Province(ProvinceID)
);


/* =========================
   MASTER TABLES
========================= */
CREATE TABLE Source (
    SourceID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    SourceName NVARCHAR(100) NOT NULL,
    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID)
);

CREATE TABLE Shift (
    ShiftID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    ShiftName NVARCHAR(50) NOT NULL,
    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID)
);


/* =========================
   STUDENT TABLE
========================= */
CREATE TABLE StudentMain (
    StudentID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    FullName NVARCHAR(100) NOT NULL,
    FirstName NVARCHAR(50),
    MiddleName NVARCHAR(50),
    LastName NVARCHAR(50),
    Gender VARCHAR(10),
    DateOfBirth NVARCHAR(20),
    PhoneNumber VARCHAR(15),
    Email NVARCHAR(100),
    Address NVARCHAR(200),
    SourceID INT,
    ShiftID INT,
    ImagePath NVARCHAR(255),
    CreatedDate NVARCHAR(20),

    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    FOREIGN KEY (SourceID) REFERENCES Source(SourceID),
    FOREIGN KEY (ShiftID) REFERENCES Shift(ShiftID)
);


/* =========================
   REFERRALS
========================= */
CREATE TABLE Referrals (
    ReferralID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    StudentID INT NOT NULL,
    ReferredByUserID INT NOT NULL,
    ReferralSourceID INT NULL,
    ReferralDate NVARCHAR(20),
    Status VARCHAR(20),
    Remarks NVARCHAR(255),

    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    FOREIGN KEY (StudentID) REFERENCES StudentMain(StudentID),
    FOREIGN KEY (ReferredByUserID) REFERENCES UserMain(UserID),
    FOREIGN KEY (ReferralSourceID) REFERENCES Source(SourceID)
);


/* =========================
   STUDENT FOLLOW UPS
========================= */
CREATE TABLE StudentFollowUps (
    FollowUpID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    ReferralID INT NOT NULL,
    FollowUpDate NVARCHAR(20),
    FollowUpType VARCHAR(50),
    FollowUpRemarks NVARCHAR(255),
    FollowedByUserID INT,

    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    FOREIGN KEY (ReferralID) REFERENCES Referrals(ReferralID),
    FOREIGN KEY (FollowedByUserID) REFERENCES UserMain(UserID)
);


/* =========================
   STAFF
========================= */
CREATE TABLE Staff (
    StaffID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    FullName NVARCHAR(100),
    Gender VARCHAR(10),
    Email NVARCHAR(100),
    PhoneNumber VARCHAR(15),
    HireDate NVARCHAR(20),
    RoleID INT,
    UserID INT,
    Religion VARCHAR(30),
    PermanentProvinceID INT,
    PermanentDistrictID INT,
    TemporaryProvinceID INT,
    TemporaryDistrictID INT,

    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    FOREIGN KEY (RoleID) REFERENCES Roles(RoleID),
    FOREIGN KEY (UserID) REFERENCES UserMain(UserID),
    FOREIGN KEY (PermanentProvinceID) REFERENCES Province(ProvinceID),
    FOREIGN KEY (PermanentDistrictID) REFERENCES District(DistrictID),
    FOREIGN KEY (TemporaryProvinceID) REFERENCES Province(ProvinceID),
    FOREIGN KEY (TemporaryDistrictID) REFERENCES District(DistrictID)
);


/* =========================
   FACULTIES
========================= */
CREATE TABLE Faculties (
    FacultyID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    FacultyName NVARCHAR(100) NOT NULL,
    Status VARCHAR(20),
    CreatedDate NVARCHAR(20),

    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    UNIQUE (TenantID, FacultyName)
);


/* =========================
   COURSES
========================= */
CREATE TABLE Courses (
    CourseID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    FacultyID INT NOT NULL,
    CourseName NVARCHAR(150) NOT NULL,
    CourseCode NVARCHAR(50),
    DurationWeeks INT,
    Fee DECIMAL(10,2),
    Description NVARCHAR(500),
    Status VARCHAR(20),
    CreatedDate NVARCHAR(20),
    CreatedByUserID INT,

    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    FOREIGN KEY (FacultyID) REFERENCES Faculties(FacultyID),
    FOREIGN KEY (CreatedByUserID) REFERENCES UserMain(UserID),
    UNIQUE (TenantID, CourseName)
);


/* =========================
   ENROLLMENTS
========================= */
CREATE TABLE Enrollments (
    EnrollmentID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    StudentID INT,
    CourseID INT,
    EnrollmentDate NVARCHAR(20),
    Status VARCHAR(20),

    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    FOREIGN KEY (StudentID) REFERENCES StudentMain(StudentID),
    FOREIGN KEY (CourseID) REFERENCES Courses(CourseID)
);


/* =========================
   BILLING
========================= */
CREATE TABLE Billing (
    BillID INT IDENTITY(1,1) PRIMARY KEY,
    TenantID INT NOT NULL,
    EnrollmentID INT,
    Amount DECIMAL(10,2),
    PaidAmount DECIMAL(10,2),

    FOREIGN KEY (TenantID) REFERENCES Tenants(TenantID),
    FOREIGN KEY (EnrollmentID) REFERENCES Enrollments(EnrollmentID)
);


ALTER TABLE Tenants ALTER COLUMN Domain nvarchar(100) NOT NULL;
ALTER TABLE Tenants ALTER COLUMN Email nvarchar(255) NOT NULL;
ALTER TABLE Tenants ALTER COLUMN Phone nvarchar(50) NOT NULL;
ALTER TABLE Tenants ALTER COLUMN Status nvarchar(50) NOT NULL;




-- ============================================================
--  ConsultancyReferrals — FIXED
--  References UserMain (your actual auth table, not Users)
--  All three nullable FKs use NO ACTION to avoid cascade cycles
-- ============================================================
CREATE TABLE [dbo].[ConsultancyReferrals]
(
    -- Primary Key
    [ConsultancyReferralID]  INT            NOT NULL IDENTITY(1,1),

    -- Who sent it (Consultancy tenant + user)
    [FromTenantID]           INT            NOT NULL,
    [SentByUserID]           INT            NULL,        -- UserMain.UserID

    -- Who receives it (Hospitality tenant)
    [ToTenantID]             INT            NOT NULL,

    -- Student details filled by consultancy
    [StudentName]            NVARCHAR(200)  NOT NULL,
    [StudentPhone]           NVARCHAR(50)   NULL,
    [StudentEmail]           NVARCHAR(200)  NULL,
    [StudentDOB]             NVARCHAR(20)   NULL,
    [StudentGender]          NVARCHAR(20)   NULL,
    [StudentAddress]         NVARCHAR(500)  NULL,
    [GuardianName]           NVARCHAR(200)  NULL,
    [GuardianPhone]          NVARCHAR(50)   NULL,

    -- Academic interest
    [InterestedCourse]       NVARCHAR(200)  NULL,
    [Qualification]          NVARCHAR(100)  NULL,
    [PreferredShift]         NVARCHAR(50)   NULL,

    -- Referral metadata
    [ReferralDate]           NVARCHAR(30)   NULL,
    [Remarks]                NVARCHAR(1000) NULL,

    -- Status managed by Hospitality
    [Status]                 NVARCHAR(50)   NOT NULL DEFAULT 'Pending',
    [HospitalityRemarks]     NVARCHAR(1000) NULL,
    [StatusUpdatedDate]      NVARCHAR(30)   NULL,
    [AssignedToUserID]       INT            NULL,        -- UserMain.UserID
    [EnrolledStudentID]      INT            NULL,        -- StudentMain.StudentID

    -- ── Primary Key ──────────────────────────────────────────
    CONSTRAINT [PK_ConsultancyReferrals]
        PRIMARY KEY CLUSTERED ([ConsultancyReferralID] ASC),

    -- ── FK → Tenants (consultancy side) ──────────────────────
    -- Simple NO ACTION — a tenant being deleted is a rare admin op,
    -- handle cleanup manually if needed
    CONSTRAINT [FK_ConsultancyReferrals_FromTenant]
        FOREIGN KEY ([FromTenantID])
        REFERENCES [dbo].[Tenants] ([TenantID])
        ON DELETE NO ACTION
        ON UPDATE NO ACTION,

    -- ── FK → Tenants (hospitality side) ──────────────────────
    CONSTRAINT [FK_ConsultancyReferrals_ToTenant]
        FOREIGN KEY ([ToTenantID])
        REFERENCES [dbo].[Tenants] ([TenantID])
        ON DELETE NO ACTION
        ON UPDATE NO ACTION,

    -- ── FK → UserMain (consultancy user who sent the referral) ─
    -- NO ACTION: if the user is deleted, the referral row stays,
    -- SentByUserID just becomes a dangling int (acceptable for audit)
    CONSTRAINT [FK_ConsultancyReferrals_SentByUser]
        FOREIGN KEY ([SentByUserID])
        REFERENCES [dbo].[UserMain] ([UserID])
        ON DELETE NO ACTION
        ON UPDATE NO ACTION,

    -- ── FK → UserMain (hospitality staff assigned to follow up) ─
    -- NO ACTION: same reason — two FKs to same table cannot both
    -- use SET NULL; SQL Server rejects it as a multi-cascade path
    CONSTRAINT [FK_ConsultancyReferrals_AssignedToUser]
        FOREIGN KEY ([AssignedToUserID])
        REFERENCES [dbo].[UserMain] ([UserID])
        ON DELETE NO ACTION
        ON UPDATE NO ACTION,

    -- ── FK → StudentMain (filled once student is enrolled) ────
    CONSTRAINT [FK_ConsultancyReferrals_EnrolledStudent]
        FOREIGN KEY ([EnrolledStudentID])
        REFERENCES [dbo].[StudentMain] ([StudentID])
        ON DELETE NO ACTION
        ON UPDATE NO ACTION
);
GO

-- ── Indexes ───────────────────────────────────────────────

-- Hospitality inbox query: WHERE ToTenantID = @myTenant
CREATE INDEX [IX_ConsultancyReferrals_ToTenantID]
    ON [dbo].[ConsultancyReferrals] ([ToTenantID]);
GO

-- Consultancy sent list: WHERE FromTenantID = @myTenant
CREATE INDEX [IX_ConsultancyReferrals_FromTenantID]
    ON [dbo].[ConsultancyReferrals] ([FromTenantID]);
GO

-- Status filter (Pending / Contacted / Enrolled / Rejected)
CREATE INDEX [IX_ConsultancyReferrals_Status]
    ON [dbo].[ConsultancyReferrals] ([Status]);
GO
