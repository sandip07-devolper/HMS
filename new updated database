-- =========================
-- Users & Roles
-- =========================
CREATE TABLE Roles (
    RoleID INT PRIMARY KEY,
    RoleName NVARCHAR(50) NOT NULL
);

CREATE TABLE Users (
    UserID INT PRIMARY KEY IDENTITY(1,1),
    Username NVARCHAR(100) UNIQUE NOT NULL,
    PasswordHash NVARCHAR(200) NOT NULL,
    RoleID INT NOT NULL,
    Email NVARCHAR(100),
    IsActive BIT DEFAULT 1,
    CreatedDate DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (RoleID) REFERENCES Roles(RoleID)
);

-- =========================
-- Geography Tables
-- =========================
CREATE TABLE Province (
    ProvinceID INT PRIMARY KEY IDENTITY(1,1),
    ProvinceName NVARCHAR(100) NOT NULL
);

CREATE TABLE District (
    DistrictID INT PRIMARY KEY IDENTITY(1,1),
    DistrictName NVARCHAR(100) NOT NULL,
    ProvinceID INT,
    DistrictName_Nep NVARCHAR(100),
    FOREIGN KEY (ProvinceID) REFERENCES Province(ProvinceID)
);

-- =========================
-- Sources & Shifts
-- =========================
CREATE TABLE Source (
    SourceID INT PRIMARY KEY IDENTITY(1,1),
    SourceName NVARCHAR(100) NOT NULL
);

CREATE TABLE Shift (
    ShiftID INT PRIMARY KEY IDENTITY(1,1),
    ShiftName NVARCHAR(50) NOT NULL
);

-- =========================
-- Students
-- =========================
CREATE TABLE StudentMain (
    StudentID INT PRIMARY KEY IDENTITY(1,1),
    FullName NVARCHAR(100) NOT NULL,
    FirstName NVARCHAR(50),
    MiddleName NVARCHAR(50),
    LastName NVARCHAR(50),
    Gender VARCHAR(10),
    DateOfBirth DATE,
    PhoneNumber VARCHAR(15),
    Email NVARCHAR(100),
    Address NVARCHAR(200),
    SourceID INT,
    ShiftID INT,
    ImagePath NVARCHAR(255),
    CreatedDate DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (SourceID) REFERENCES Source(SourceID),
    FOREIGN KEY (ShiftID) REFERENCES Shift(ShiftID)
);

-- =========================
-- Referrals & Follow-ups
-- =========================
CREATE TABLE Referrals (
    ReferralID INT PRIMARY KEY IDENTITY(1,1),
    StudentID INT NOT NULL,
    ReferredByUserID INT NOT NULL,
    ReferralSourceID INT NULL,
    ReferralDate DATETIME DEFAULT GETDATE(),
    Status VARCHAR(20) DEFAULT 'Pending', -- Pending, Contacted, Enrolled, Rejected
    Remarks NVARCHAR(255),
    FOREIGN KEY (StudentID) REFERENCES StudentMain(StudentID),
    FOREIGN KEY (ReferredByUserID) REFERENCES Users(UserID),
    FOREIGN KEY (ReferralSourceID) REFERENCES Source(SourceID)
);

CREATE TABLE StudentFollowUps (
    FollowUpID INT PRIMARY KEY IDENTITY(1,1),
    ReferralID INT NOT NULL,
    FollowUpDate DATETIME DEFAULT GETDATE(),
    FollowUpType VARCHAR(50), -- Call, Email, Meeting, SMS
    FollowUpRemarks NVARCHAR(255),
    FollowedByUserID INT,
    FOREIGN KEY (ReferralID) REFERENCES Referrals(ReferralID),
    FOREIGN KEY (FollowedByUserID) REFERENCES Users(UserID)
);

-- =========================
-- Referral Incentives (Optional)
-- =========================
CREATE TABLE ReferralIncentives (
    IncentiveID INT PRIMARY KEY IDENTITY(1,1),
    ReferralID INT NOT NULL,
    StaffID INT NOT NULL,
    IncentiveAmount DECIMAL(10,2) NOT NULL,
    Paid BIT DEFAULT 0,
    PaidDate DATE NULL,
    FOREIGN KEY (ReferralID) REFERENCES Referrals(ReferralID),
    FOREIGN KEY (StaffID) REFERENCES Staff(StaffID)
);

-- =========================
-- Faculty, Courses & Enrollments
-- =========================
CREATE TABLE Faculty (
    FacultyID INT PRIMARY KEY IDENTITY(1,1),
    FacultyName NVARCHAR(50) NOT NULL,
    Status VARCHAR(5) DEFAULT 'Active'
);

CREATE TABLE Courses (
    CourseID INT PRIMARY KEY IDENTITY(1,1),
    CourseName NVARCHAR(100) NOT NULL,
    FacultyID INT,
    Description NVARCHAR(255),
    DurationWeeks INT,
    Fee DECIMAL(10,2),
    Status VARCHAR(20) DEFAULT 'Active',
    FOREIGN KEY (FacultyID) REFERENCES Faculty(FacultyID)
);

CREATE TABLE Enrollments (
    EnrollmentID INT PRIMARY KEY IDENTITY(1,1),
    StudentID INT NOT NULL,
    CourseID INT NOT NULL,
    EnrollmentDate DATE DEFAULT GETDATE(),
    CompletionDate DATE NULL,
    Status VARCHAR(20) DEFAULT 'Enrolled',
    FOREIGN KEY (StudentID) REFERENCES StudentMain(StudentID),
    FOREIGN KEY (CourseID) REFERENCES Courses(CourseID)
);

-- =========================
-- Billing & Receipts
-- =========================
CREATE TABLE Billing (
    BillID INT PRIMARY KEY IDENTITY(1,1),
    EnrollmentID INT NOT NULL,
    BillDate DATE DEFAULT GETDATE(),
    Amount DECIMAL(10,2) NOT NULL,
    PaidAmount DECIMAL(10,2) DEFAULT 0,
    DueAmount AS (Amount - PaidAmount),
    PaymentStatus VARCHAR(20) DEFAULT 'Unpaid',
    FOREIGN KEY (EnrollmentID) REFERENCES Enrollments(EnrollmentID)
);

CREATE TABLE Receipts (
    ReceiptID INT PRIMARY KEY IDENTITY(1,1),
    BillID INT NOT NULL,
    ReceiptDate DATE DEFAULT GETDATE(),
    PaidAmount DECIMAL(10,2) NOT NULL,
    PaymentMethod VARCHAR(50),
    FOREIGN KEY (BillID) REFERENCES Billing(BillID)
);

-- =========================
-- Staff & Course Assignments
-- =========================
CREATE TABLE Staff (
    StaffID INT PRIMARY KEY IDENTITY(1,1),
    FullName NVARCHAR(100),
    Gender VARCHAR(10),
    Email NVARCHAR(100),
    PhoneNumber VARCHAR(15),
    HireDate DATE,
    RoleID INT,
    UserID INT,
    Religion VARCHAR(30),
    PermanentProvinceID INT,
    PermanentDistrictID INT,
    PermanentMunicipality NVARCHAR(100),
    PermanentWardNo VARCHAR(5),
    PermanentTole NVARCHAR(100),
    TemporaryProvinceID INT,
    TemporaryDistrictID INT,
    TemporaryMunicipality NVARCHAR(100),
    TemporaryWardNo INT,
    TemporaryTole NVARCHAR(100),
    FOREIGN KEY (RoleID) REFERENCES Roles(RoleID),
    FOREIGN KEY (UserID) REFERENCES Users(UserID),
    FOREIGN KEY (PermanentProvinceID) REFERENCES Province(ProvinceID),
    FOREIGN KEY (PermanentDistrictID) REFERENCES District(DistrictID),
    FOREIGN KEY (TemporaryProvinceID) REFERENCES Province(ProvinceID),
    FOREIGN KEY (TemporaryDistrictID) REFERENCES District(DistrictID)
);

CREATE TABLE CourseAssignments (
    AssignmentID INT PRIMARY KEY IDENTITY(1,1),
    CourseID INT NOT NULL,
    StaffID INT NOT NULL,
    AssignedDate DATE DEFAULT GETDATE(),
    FOREIGN KEY (CourseID) REFERENCES Courses(CourseID),
    FOREIGN KEY (StaffID) REFERENCES Staff(StaffID)
);

-- =========================
-- Visitors / Walk-ins
-- =========================
CREATE TABLE Visitor (
    VisitorId INT PRIMARY KEY IDENTITY(1,1),
    Name NVARCHAR(50) NOT NULL,
    Email NVARCHAR(50) NULL,
    Address NVARCHAR(100) NULL,
    Phone NVARCHAR(20) NOT NULL,
    Purpose NVARCHAR(100) NULL,
    Remarks NVARCHAR(255) NULL,
    CreatedDate DATETIME DEFAULT GETDATE(),
    CreatedByUserID INT NULL,
    FOREIGN KEY (CreatedByUserID) REFERENCES Users(UserID)
);

-- =========================
-- Notifications & Follow-up Calendar
-- =========================
CREATE TABLE Notifications (
    NotificationID INT PRIMARY KEY IDENTITY(1,1),
    UserID INT NOT NULL,
    Message NVARCHAR(255) NOT NULL,
    NotificationDate DATETIME DEFAULT GETDATE(),
    IsRead BIT DEFAULT 0,
    RelatedReferralID INT NULL,
    RelatedEnrollmentID INT NULL,
    FOREIGN KEY (UserID) REFERENCES Users(UserID),
    FOREIGN KEY (RelatedReferralID) REFERENCES Referrals(ReferralID),
    FOREIGN KEY (RelatedEnrollmentID) REFERENCES Enrollments(EnrollmentID)
);

CREATE TABLE FollowUpSchedule (
    ScheduleID INT PRIMARY KEY IDENTITY(1,1),
    ReferralID INT NOT NULL,
    ScheduledDate DATETIME NOT NULL,
    Notes NVARCHAR(255),
    AssignedToUserID INT NOT NULL,
    Status VARCHAR(20) DEFAULT 'Pending', -- Pending, Completed, Missed
    FOREIGN KEY (ReferralID) REFERENCES Referrals(ReferralID),
    FOREIGN KEY (AssignedToUserID) REFERENCES Users(UserID)
);

-- =========================
-- Document Management
-- =========================
CREATE TABLE StudentDocuments (
    DocumentID INT PRIMARY KEY IDENTITY(1,1),
    StudentID INT NOT NULL,
    FileName NVARCHAR(255),
    FilePath NVARCHAR(500),
    DocumentType VARCHAR(50), -- ID, Certificate, Photo, etc.
    UploadedDate DATETIME DEFAULT GETDATE(),
    UploadedByUserID INT,
    FOREIGN KEY (StudentID) REFERENCES StudentMain(StudentID),
    FOREIGN KEY (UploadedByUserID) REFERENCES Users(UserID)
);
